<!--추가-->
{% extends 'base.html' %}

{% block content %}

    <div id="login">
        <form method="post">
            <h1>Pystagram</h1>
            {% csrf_token %}
            <!--    추가-->
            {{ form.as_p }}
            <button id="auth-btn" type="button" class="btn btn-login">본인인증</button>
            <p id="code-input" style="display: none">
                <label for="verify_code">코드 확인:</label>
                <input type="text" name="input_code" placeholder="6자리 숫자코드 입력해주세요" minlength="6" required
                       id="input_code">
            </p>
            <div id="code-time" style="display: none">
                <span>코드 입력 남은 유효 시간 : </span> <span id="countdown" style="color: red"></span>
            </div>
            <button id="verify-btn" type="button" class="btn btn-login" style="display: none">코드확인</button>
            <button type="submit" class="btn btn-login">로그인</button>
            <!--        <a href="/users/signup/">회원가입 페이지 이동</a>-->
            <!--        수정-->
            <a href="{% url 'users:signup' %}">회원가입 페이지 이동</a>
            <a href="{% url 'users:auth_email' %}">ID 찾기 페이지 이동</a>
        </form>
    </div>
    <script>
        // CSRF 토큰 값을 가져오는 함수
        function getCSRFToken() {
            var cookieValue = null;
            var name = 'csrftoken';
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
            return cookieValue;
        }

        // 버튼 클릭 이벤트 핸들러
        document.getElementById('auth-btn').addEventListener('click', function () {
            var div = document.getElementById('code-time');
            var paragraph = document.getElementById('code-input');
            var verifyBtn = document.getElementById('verify-btn');
            var id_username = document.getElementById('id_username');

            var usernameValue = id_username.value;
            {#alert("usernameValue: " + usernameValue);#}

            // POST 요청으로 보낼 데이터 객체 생성
            var data = {
                verify_email: 'lsy3709@naver.com'  // 원하는 이메일 값을 여기에 설정
            };

            // CSRF 토큰 가져오기
            var csrfToken = getCSRFToken();

// Fetch API를 사용하여 POST 요청 보내기
            fetch('http://localhost:8000/users/send_email_with_code_rest2/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',  // 폼 데이터 형식으로 전송
                    'X-CSRFToken': csrfToken  // CSRF 토큰 추가
                },
                body: new URLSearchParams(data).toString()  // 데이터를 URL 쿼리 문자열로 변환하여 전송
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();  // 서버에서 반환된 JSON 데이터를 파싱
                })
                .then(data => {
                    // 서버 응답 데이터(data)를 처리
                    console.log(data);
                })
                .catch(error => {
                    // 오류 처리
                    console.error('There was a problem with the fetch operation:', error);
                });

            // div와 p 태그를 토글링 (보이기/감추기)
            if (div.style.display === 'none') {
                div.style.display = 'block';
                paragraph.style.display = 'block';
                verifyBtn.style.display = 'block';
            } else {
                div.style.display = 'none';
                paragraph.style.display = 'none';
                verifyBtn.style.display = 'none';
            }
        });

        // 5분(300초) 카운트 다운 시작
        let countdownSeconds = 300;

        function updateCountdown() {
            const countdownElement = document.getElementById('countdown');
            const minutes = Math.floor(countdownSeconds / 60);
            const seconds = countdownSeconds % 60;

            // 카운트 다운 표시
            countdownElement.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            if (countdownSeconds > 0) {
                countdownSeconds--;
                setTimeout(updateCountdown, 1000); // 1초마다 업데이트
            } else {
                countdownElement.innerText = '시간 종료';
            }
        }

        // 페이지 로드 후 카운트 다운 시작
        window.addEventListener('load', updateCountdown);
    </script>
{% endblock %}